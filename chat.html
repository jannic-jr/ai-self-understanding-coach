<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå·±ç†è§£ã‚³ãƒ¼ãƒ - AI ãƒãƒ£ãƒƒãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#0F0F23',
                        'secondary': '#1A1A2E',
                        'accent': '#16213E',
                        'chat-bg': '#2D2D30',
                        'sidebar-bg': '#1E1E1E',
                        'message-user': '#0084FF',
                        'message-ai': '#F1F1F1',
                    },
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #2D2D30;
            color: #ffffff;
        }
        
        .sidebar-scroll::-webkit-scrollbar {
            width: 4px;
        }
        
        .sidebar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }
        
        .chat-scroll::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-scroll::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .message-animation {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9CA3AF;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .login-modal {
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.8);
        }
    </style>
</head>
<body class="h-screen overflow-hidden">
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="loginModal" class="fixed inset-0 login-modal flex items-center justify-center z-50">
        <div class="bg-sidebar-bg rounded-2xl p-8 max-w-md w-full mx-4 border border-gray-700">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-2xl">ğŸ¤–</span>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">è‡ªå·±ç†è§£ã‚³ãƒ¼ãƒ</h2>
                <p class="text-gray-400">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦è‡ªå·±ç†è§£ã®æ—…ã‚’å§‹ã‚ã¾ã—ã‚‡ã†</p>
            </div>
            
            <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="loginFormContainer">
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-300 mb-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
                        <input type="text" id="username" name="username" required 
                               class="w-full px-4 py-3 bg-chat-bg border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-white placeholder-gray-400"
                               placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-300 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="password" name="password" required
                               class="w-full px-4 py-3 bg-chat-bg border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-white placeholder-gray-400"
                               placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-300 mb-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆæ–°è¦ç™»éŒ²æ™‚ã®ã¿ï¼‰</label>
                        <input type="email" id="email" name="email"
                               class="w-full px-4 py-3 bg-chat-bg border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-white placeholder-gray-400"
                               placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ï¼ˆä»»æ„ï¼‰">
                    </div>
                    <button type="submit" 
                            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 px-6 rounded-lg font-medium hover:from-blue-600 hover:to-purple-700 transition-all duration-200 transform hover:scale-105">
                        ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                </form>
                
                <div class="mt-4 text-center">
                    <button id="forgotPasswordBtn" class="text-blue-400 hover:text-blue-300 text-sm underline">
                        ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸæ–¹ã¯ã“ã¡ã‚‰
                    </button>
                </div>
            </div>

            <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="resetFormContainer" class="hidden">
                <form id="resetForm" class="space-y-6">
                    <div>
                        <label for="resetEmail" class="block text-sm font-medium text-gray-300 mb-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" id="resetEmail" name="resetEmail" required
                               class="w-full px-4 py-3 bg-chat-bg border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-white placeholder-gray-400"
                               placeholder="ç™»éŒ²ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›">
                    </div>
                    <button type="submit" 
                            class="w-full bg-gradient-to-r from-purple-500 to-pink-600 text-white py-3 px-6 rounded-lg font-medium hover:from-purple-600 hover:to-pink-700 transition-all duration-200 transform hover:scale-105">
                        ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é€ä¿¡
                    </button>
                </form>
                
                <div class="mt-4 text-center">
                    <button id="backToLoginBtn" class="text-gray-400 hover:text-white text-sm underline">
                        ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
                    </button>
                </div>
            </div>
            
            <div class="mt-6 text-center">
                <p class="text-gray-400 text-sm">
                    ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„å ´åˆã¯ã€<br>
                    ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™
                </p>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
    <div id="mainApp" class="hidden h-full flex">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div class="w-80 bg-sidebar-bg border-r border-gray-700 flex flex-col">
            <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="p-4 border-b border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                            <span class="text-lg">ğŸ¤–</span>
                        </div>
                        <div>
                            <h1 class="text-lg font-semibold text-white">è‡ªå·±ç†è§£ã‚³ãƒ¼ãƒ</h1>
                            <p class="text-xs text-gray-400" id="userInfo">ãƒ­ã‚°ã‚¤ãƒ³ä¸­...</p>
                        </div>
                    </div>
                    <button id="logoutBtn" class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </button>
                </div>
                <button id="newChatBtn" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-2 px-4 rounded-lg font-medium hover:from-blue-600 hover:to-purple-700 transition-all duration-200 flex items-center justify-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span>æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ</span>
                </button>
            </div>

            <!-- ãƒãƒ£ãƒƒãƒˆå±¥æ­´ -->
            <div class="flex-1 overflow-y-auto sidebar-scroll">
                <div class="p-4">
                    <h2 class="text-sm font-medium text-gray-400 mb-3">ãƒãƒ£ãƒƒãƒˆå±¥æ­´</h2>
                    <div id="chatHistory" class="space-y-2">
                        <!-- ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                </div>
            </div>

            <!-- Want to çµæœè¡¨ç¤º -->
            <div class="p-4 border-t border-gray-700">
                <h3 class="text-sm font-medium text-gray-400 mb-2">ã‚ãªãŸã®Want to</h3>
                <div id="latestWantTo" class="bg-chat-bg rounded-lg p-3 text-sm text-gray-300 transition-all duration-300">
                    ã¾ã Want toãŒç‰¹å®šã•ã‚Œã¦ã„ã¾ã›ã‚“
                </div>
                <div class="text-xs text-gray-500 mt-2">
                    â€» ã‚»ãƒƒã‚·ãƒ§ãƒ³é–“ã§å…±æœ‰ãƒ»æ›´æ–°ã•ã‚Œã¾ã™
                </div>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
        <div class="flex-1 flex flex-col">
            <!-- ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="bg-sidebar-bg border-b border-gray-700 p-4">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-blue-500 rounded-full flex items-center justify-center">
                        <span class="text-sm">ğŸ¯</span>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-white">è‡ªå·±ç†è§£ã‚»ãƒƒã‚·ãƒ§ãƒ³</h2>
                        <p class="text-xs text-gray-400">ã‚ãªãŸã®Want toã‚’è¦‹ã¤ã‘ã‚‹ãŠæ‰‹ä¼ã„ã‚’ã—ã¾ã™</p>
                    </div>
                </div>
            </div>

            <!-- ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
            <div class="flex-1 overflow-y-auto chat-scroll p-4" id="chatMessages">
                <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
            </div>

            <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="border-t border-gray-700 p-4">
                <div class="flex items-end space-x-4">
                    <div class="flex-1">
                        <textarea id="messageInput" 
                                  placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                                  class="w-full bg-chat-bg border border-gray-600 rounded-2xl px-4 py-3 text-white placeholder-gray-400 resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  rows="1"></textarea>
                    </div>
                    <button id="sendBtn" 
                            class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-3 rounded-full hover:from-blue-600 hover:to-purple-700 transition-all duration-200 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>
                <div class="mt-2 text-xs text-gray-500 text-center">
                    Enterã§é€ä¿¡ã€Shift+Enterã§æ”¹è¡Œ
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentUser = null;
        let currentChatId = null;
        let allChats = {}; // å…¨ã¦ã®ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ {chatId: {title, messages, createdAt}}
        let isTyping = false;

        // APIè¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ï¼‰
        const AIRTABLE_CONFIG = {
            apiKey: 'patL8zsxO1oyIi1DL.862651908e2c8aa4c734cf5cb8806d64f6384df9687e8171ba1fa01066611c50', // å®Ÿéš›ã®ãƒˆãƒ¼ã‚¯ãƒ³ã«ç½®ãæ›ãˆã¦ãã ã•ã„
            baseId: 'appbMWFxmPPLoiCQb', // å®Ÿéš›ã®Base IDã«ç½®ãæ›ãˆã¦ãã ã•ã„
            usersTable: 'Users',
            wantToTable: 'WantTo'
        };

        const DIFY_CONFIG = {
            apiKey: 'app-mfvwHL3Q3bF2oYNY53NTr3cJ', // å®Ÿéš›ã®Dify APIã‚­ãƒ¼ã«ç½®ãæ›ãˆã¦ãã ã•ã„
            baseUrl: 'https://api.dify.ai/v1',
            appId: '8482ba6e-780f-4e39-8568-fe59917b5080' // å®Ÿéš›ã®Dify App IDã«ç½®ãæ›ãˆã¦ãã ã•ã„
        };

        // é–‹ç™ºãƒ¢ãƒ¼ãƒ‰è¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯falseã«è¨­å®šï¼‰
        const USE_SIMULATION = false; // trueã®å ´åˆã¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€falseã®å ´åˆã¯å®Ÿéš›ã®Dify API

        // EmailJSè¨­å®šï¼ˆhttps://www.emailjs.com/ã§è¨­å®šãŒå¿…è¦ï¼‰
        const EMAILJS_CONFIG = {
            publicKey: 'ghLTSy0d9oTPnEFzC', // EmailJSã®å…¬é–‹ã‚­ãƒ¼
            serviceId: 'service_735u582', // EmailJSã®ã‚µãƒ¼ãƒ“ã‚¹ID
            templateId: 'template_4gr30po' // EmailJSã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID
        };

        // EmailJSã‚’åˆæœŸåŒ–
        if (typeof emailjs !== 'undefined') {
            emailjs.init(EMAILJS_CONFIG.publicKey);
        }

        // Airtable APIé–¢æ•°
        class AirtableAPI {
            constructor(config) {
                this.config = config;
                this.baseUrl = `https://api.airtable.com/v0/${config.baseId}`;
                this.headers = {
                    'Authorization': `Bearer ${config.apiKey}`,
                    'Content-Type': 'application/json'
                };
            }

            async createUser(userId, password, email = null) {
                try {
                    const fields = {
                        user_id: userId,
                        password: password
                    };
                    
                    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæä¾›ã•ã‚ŒãŸå ´åˆã®ã¿è¿½åŠ 
                    if (email) {
                        fields.email = email;
                    }
                    
                    const response = await fetch(`${this.baseUrl}/${this.config.usersTable}`, {
                        method: 'POST',
                        headers: this.headers,
                        body: JSON.stringify({
                            fields: fields
                        })
                    });
                    return await response.json();
                } catch (error) {
                    console.error('Error creating user:', error);
                    return null;
                }
            }

            async getUserByEmail(email) {
                try {
                    const response = await fetch(
                        `${this.baseUrl}/${this.config.usersTable}?filterByFormula={email}="${email}"`,
                        {
                            headers: this.headers
                        }
                    );
                    const data = await response.json();
                    return data.records.length > 0 ? data.records[0] : null;
                } catch (error) {
                    console.error('Error getting user by email:', error);
                    return null;
                }
            }

            async getUserByUserId(userId) {
                try {
                    const response = await fetch(
                        `${this.baseUrl}/${this.config.usersTable}?filterByFormula={user_id}="${userId}"`,
                        {
                            headers: this.headers
                        }
                    );
                    const data = await response.json();
                    return data.records.length > 0 ? data.records[0] : null;
                } catch (error) {
                    console.error('Error getting user:', error);
                    return null;
                }
            }

            async saveWantTo(userId, wantToContent, confidenceLevel = 5) {
                try {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¢å­˜ã®Want toã‚’ç¢ºèªï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã«é–¢ä¿‚ãªãï¼‰
                    const existingResponse = await fetch(
                        `${this.baseUrl}/${this.config.wantToTable}?filterByFormula={user_id}="${userId}"`,
                        {
                            headers: this.headers
                        }
                    );
                    const existingData = await existingResponse.json();

                    if (existingData.records.length > 0) {
                        // æ—¢å­˜ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ï¼ˆæœ€æ–°ã®ã‚‚ã®ã‚’æ›´æ–°ï¼‰
                        const recordId = existingData.records[0].id;
                        const response = await fetch(`${this.baseUrl}/${this.config.wantToTable}/${recordId}`, {
                            method: 'PATCH',
                            headers: this.headers,
                            body: JSON.stringify({
                                fields: {
                                    want_to_content: wantToContent,
                                    confidence_level: confidenceLevel,
                                    session_id: currentChatId // ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã§æ›´æ–°
                                }
                            })
                        });
                        return await response.json();
                    } else {
                        // æ–°è¦ä½œæˆï¼ˆåˆå›ã®ã¿ï¼‰
                        const response = await fetch(`${this.baseUrl}/${this.config.wantToTable}`, {
                            method: 'POST',
                            headers: this.headers,
                            body: JSON.stringify({
                                fields: {
                                    user_id: userId,
                                    want_to_content: wantToContent,
                                    session_id: currentChatId,
                                    confidence_level: confidenceLevel
                                }
                            })
                        });
                        return await response.json();
                    }
                } catch (error) {
                    console.error('Error saving Want to:', error);
                    return null;
                }
            }

            async getLatestWantTo(userId) {
                try {
                    const response = await fetch(
                        `${this.baseUrl}/${this.config.wantToTable}?filterByFormula={user_id}="${userId}"&sort[0][field]=created_at&sort[0][direction]=desc&maxRecords=1`,
                        {
                            headers: this.headers
                        }
                    );
                    const data = await response.json();
                    return data.records.length > 0 ? data.records[0] : null;
                } catch (error) {
                    console.error('Error getting latest Want to:', error);
                    return null;
                }
            }
        }

        // Dify APIé–¢æ•°
        class DifyAPI {
            constructor(config) {
                this.config = config;
                this.conversationId = null;
                this.headers = {
                    'Authorization': `Bearer ${config.apiKey}`,
                    'Content-Type': 'application/json'
                };
            }

            async sendMessage(message, userId) {
                try {
                    const requestBody = {
                        inputs: {},
                        query: message,
                        response_mode: "blocking",
                        user: userId
                    };

                    // æ—¢å­˜ã®ä¼šè©±ãŒã‚ã‚‹å ´åˆã¯ conversation_id ã‚’è¿½åŠ 
                    if (this.conversationId) {
                        requestBody.conversation_id = this.conversationId;
                    }

                    const response = await fetch(`${this.config.baseUrl}/chat-messages`, {
                        method: 'POST',
                        headers: this.headers,
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // conversation_idã‚’ä¿å­˜
                    if (data.conversation_id) {
                        this.conversationId = data.conversation_id;
                    }

                    return {
                        message: data.answer,
                        conversationId: data.conversation_id,
                        messageId: data.id
                    };
                } catch (error) {
                    console.error('Error sending message to Dify:', error);
                    throw error;
                }
            }

            // æ–°ã—ã„ä¼šè©±ã‚’é–‹å§‹
            startNewConversation() {
                this.conversationId = null;
            }

            // Want toã®æŠ½å‡ºã‚’è©¦ã¿ã‚‹ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
            extractWantTo(message) {
                // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ã‚ˆã‚Šé«˜åº¦ãªNLPã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡ºã‚’ä½¿ç”¨
                const wantToIndicators = [
                    'want to',
                    'ã‚„ã‚ŠãŸã„ã“ã¨',
                    'æ¬²æ±‚',
                    'æœ¬å½“ã«ã‚„ã‚ŠãŸã„',
                    'ã—ãŸã„ã“ã¨',
                    'æƒ…ç†±',
                    'å¤¢ä¸­ã«ãªã‚Œã‚‹'
                ];

                const lowerMessage = message.toLowerCase();
                const hasWantToIndicator = wantToIndicators.some(indicator => 
                    lowerMessage.includes(indicator)
                );

                if (hasWantToIndicator) {
                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰å…·ä½“çš„ãªWant toã‚’æŠ½å‡ºã™ã‚‹ç°¡æ˜“å®Ÿè£…
                    // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ã‚ˆã‚Šç²¾å¯†ãªæŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨
                    const sentences = message.split(/[ã€‚ï¼ï¼ï¼Ÿ\n]/);
                    for (const sentence of sentences) {
                        if (sentence.length > 10 && wantToIndicators.some(indicator => 
                            sentence.toLowerCase().includes(indicator))) {
                            return {
                                wantTo: sentence.trim(),
                                confidence: 7 // 1-10ã®ã‚¹ã‚±ãƒ¼ãƒ«
                            };
                        }
                    }
                }

                return null;
            }
        }

        const airtableAPI = new AirtableAPI(AIRTABLE_CONFIG);
        const difyAPI = new DifyAPI(DIFY_CONFIG);

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const email = document.getElementById('email').value;
            
            if (username && password) {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';
                submitBtn.disabled = true;

                try {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­˜åœ¨ç¢ºèª
                    let user = await airtableAPI.getUserByUserId(username);
                    
                    if (!user) {
                        // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€ä½œæˆ
                        user = await airtableAPI.createUser(username, password, email);
                        if (!user) {
                            throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                        }
                    } else {
                        // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
                        if (user.fields.password !== password) {
                            throw new Error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                        }
                    }

                    currentUser = {
                        id: username,
                        password: password,
                        airtableId: user.id
                    };
                    
                    // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
                    document.getElementById('loginModal').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    document.getElementById('userInfo').textContent = `${username}ã•ã‚“`;
                    
                    // æœ€æ–°ã®Want toã‚’èª­ã¿è¾¼ã¿
                    await loadLatestWantTo();
                    
                    // æœ€åˆã®ãƒãƒ£ãƒƒãƒˆã‚’åˆæœŸåŒ–
                    initializeFirstChat();
                    
                } catch (error) {
                    alert('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ' + error.message);
                } finally {
                    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è§£é™¤
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            }
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        document.getElementById('logoutBtn').addEventListener('click', function() {
            // ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆçŠ¶æ…‹ã‚’ä¿å­˜
            if (currentChatId && allChats[currentChatId]) {
                saveCurrentChatState();
            }
            
            currentUser = null;
            currentChatId = null;
            allChats = {}; // ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        });

        // æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆé–‹å§‹
        document.getElementById('newChatBtn').addEventListener('click', startNewChat);

        // åˆå›ãƒãƒ£ãƒƒãƒˆã‚’åˆæœŸåŒ–
        function initializeFirstChat() {
            currentChatId = 'chat_' + Date.now();
            allChats[currentChatId] = {
                title: 'æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³',
                messages: [],
                createdAt: new Date(),
                messageCount: 0
            };
            
            // åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            showInitialMessage();
            
            // Difyã®æ–°ã—ã„ä¼šè©±ã‚’é–‹å§‹
            difyAPI.startNewConversation();
            
            // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’æ›´æ–°
            updateChatHistory();
        }

        function startNewChat() {
            // ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ä¿å­˜
            if (currentChatId && allChats[currentChatId]) {
                saveCurrentChatState();
            }
            
            // æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆIDã‚’ç”Ÿæˆ
            currentChatId = 'chat_' + Date.now();
            
            // æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
            allChats[currentChatId] = {
                title: 'æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³',
                messages: [],
                createdAt: new Date(),
                messageCount: 0
            };
            
            // ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’ã‚¯ãƒªã‚¢
            clearChatMessages();
            
            // åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            showInitialMessage();
            
            // Difyã®æ–°ã—ã„ä¼šè©±ã‚’é–‹å§‹
            difyAPI.startNewConversation();
            
            // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’æ›´æ–°
            updateChatHistory();
        }

        // ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆçŠ¶æ…‹ã‚’ä¿å­˜
        function saveCurrentChatState() {
            if (!currentChatId || !allChats[currentChatId]) return;
            
            const chatMessages = document.getElementById('chatMessages');
            const messageElements = chatMessages.querySelectorAll('.flex:not(#typingIndicator)');
            
            // åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é™¤ã
            const messages = [];
            messageElements.forEach((element, index) => {
                if (index === 0) return; // åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚¹ã‚­ãƒƒãƒ—
                
                const isUser = element.classList.contains('justify-end');
                const messageContent = element.querySelector('.bg-message-user, .bg-message-ai');
                if (messageContent) {
                    messages.push({
                        content: messageContent.innerHTML,
                        sender: isUser ? 'user' : 'ai',
                        timestamp: new Date()
                    });
                }
            });
            
            allChats[currentChatId].messages = messages;
            allChats[currentChatId].messageCount = messages.length;
        }

        // ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’ã‚¯ãƒªã‚¢
        function clearChatMessages() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
        }

        // åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        function showInitialMessage() {
            const chatMessages = document.getElementById('chatMessages');
            const initialMessage = document.createElement('div');
            initialMessage.className = 'flex items-start space-x-3 mb-6';
            initialMessage.innerHTML = `
                <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="text-sm">ğŸ¤–</span>
                </div>
                <div class="bg-message-ai text-gray-800 rounded-2xl rounded-tl-md p-4 max-w-2xl">
                    <p class="mb-3">ã“ã‚“ã«ã¡ã¯ï¼ç§ã¯è‡ªå·±ç†è§£ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã‚³ãƒ¼ãƒã§ã™ã€‚</p>
                    <p class="mb-3">ä»Šæ—¥ã¯ã€ã‚ãªãŸã®å¿ƒã®åº•ã‹ã‚‰ã‚„ã‚ŠãŸã„ã“ã¨ï¼ˆWant toï¼‰ã‚’ä¸€ç·’ã«è¦‹ã¤ã‘ã¦ã„ãã¾ã—ã‚‡ã†ã€‚</p>
                    <p>ã“ã®ä¼šè©±ã‚’é€šã˜ã¦ã€ã‚ãªãŸè‡ªèº«ã®æœ¬è³ªçš„ãªæ¬²æ±‚ã‚’ç†è§£ã—ã€ãã‚ŒãŒç¤¾ä¼šã«ã©ã®ã‚ˆã†ã«è²¢çŒ®ã§ãã‚‹ã‹ã‚’æ˜ç¢ºã«ã—ã¦ã„ãã¾ã™ã€‚</p>
                    <p class="mt-3 font-medium">æº–å‚™ã¯ã„ã‹ãŒã§ã™ã‹ï¼Ÿè‡ªå·±ç†è§£ã®æ—…ã‚’å§‹ã‚ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ</p>
                </div>
            `;
            chatMessages.appendChild(initialMessage);
        }

        // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’æ›´æ–°
        function updateChatHistory() {
            const historyContainer = document.getElementById('chatHistory');
            historyContainer.innerHTML = '';
            
            // æ—¥ä»˜é †ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
            const sortedChats = Object.entries(allChats).sort((a, b) => 
                new Date(b[1].createdAt) - new Date(a[1].createdAt)
            );
            
            console.log('Updating chat history with', sortedChats.length, 'chats');
            
            sortedChats.forEach(([chatId, chatData]) => {
                addChatToHistory(chatId, chatData.title, chatData.createdAt, chatData.messageCount);
            });
        }

        // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«è¿½åŠ 
        function addChatToHistory(chatId, title, createdAt, messageCount = 0) {
            const historyContainer = document.getElementById('chatHistory');
            const chatItem = document.createElement('div');
            
            // ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆã‹ã©ã†ã‹ã§èƒŒæ™¯è‰²ã‚’å¤‰ãˆã‚‹
            const isCurrentChat = chatId === currentChatId;
            const bgClass = isCurrentChat ? 'bg-gray-700 border-blue-500' : 'hover:bg-gray-700 hover:border-blue-500';
            
            chatItem.className = `p-3 rounded-lg cursor-pointer transition-colors duration-200 border-l-2 border-transparent ${bgClass}`;
            chatItem.innerHTML = `
                <div class="text-sm font-medium text-white truncate">${title}</div>
                <div class="text-xs text-gray-500 mt-1">${messageCount > 0 ? `${messageCount}ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸` : 'æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³'}</div>
                <div class="text-xs text-gray-400 mt-1">${new Date(createdAt).toLocaleString('ja-JP')}</div>
            `;
            chatItem.onclick = () => loadChat(chatId);
            
            historyContainer.appendChild(chatItem);
        }

        // ãƒãƒ£ãƒƒãƒˆèª­ã¿è¾¼ã¿
        function loadChat(chatId) {
            if (chatId === currentChatId) return; // ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
            
            // ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆçŠ¶æ…‹ã‚’ä¿å­˜
            if (currentChatId && allChats[currentChatId]) {
                saveCurrentChatState();
            }
            
            // æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã«åˆ‡ã‚Šæ›¿ãˆ
            currentChatId = chatId;
            
            // ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’ã‚¯ãƒªã‚¢
            clearChatMessages();
            
            // åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            showInitialMessage();
            
            // ä¿å­˜ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¾©å…ƒ
            const chatData = allChats[chatId];
            if (chatData && chatData.messages) {
                chatData.messages.forEach(msg => {
                    addMessageToUI(msg.content, msg.sender, false); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã§è¿½åŠ 
                });
            }
            
            // Difyã®ä¼šè©±ã‚’ãƒªã‚»ãƒƒãƒˆ
            difyAPI.startNewConversation();
            
            // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            updateChatHistory();
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å‡¦ç†
        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚º
        document.getElementById('messageInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || isTyping) return;
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            addMessage(message, 'user');
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // AIã®å¿œç­”ã‚’å–å¾—ï¼ˆè¨­å®šã«å¿œã˜ã¦ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¾ãŸã¯å®Ÿéš›ã®APIï¼‰
            if (USE_SIMULATION) {
                simulateAIResponse(message);
            } else {
                getAIResponse(message);
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’UIã«è¿½åŠ ï¼ˆå†…éƒ¨ç”¨ï¼‰
        function addMessageToUI(content, sender, animate = true) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            if (sender === 'user') {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼šå³å´ã«è¡¨ç¤º
                messageDiv.className = `flex items-start justify-end space-x-3 mb-6 ${animate ? 'message-animation' : ''}`;
                messageDiv.innerHTML = `
                    <div class="bg-message-user text-white rounded-2xl rounded-tr-md p-4 max-w-2xl">
                        ${content}
                    </div>
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-sm">ğŸ‘¤</span>
                    </div>
                `;
            } else {
                // AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼šå·¦å´ã«è¡¨ç¤º
                messageDiv.className = `flex items-start space-x-3 mb-6 ${animate ? 'message-animation' : ''}`;
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-sm">ğŸ¤–</span>
                    </div>
                    <div class="bg-message-ai text-gray-800 rounded-2xl rounded-tl-md p-4 max-w-2xl">
                        ${content}
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ ï¼ˆå¤–éƒ¨ç”¨ï¼‰
        function addMessage(content, sender) {
            // UIã«è¡¨ç¤º
            const formattedContent = content.replace(/\n/g, '<br>');
            addMessageToUI(formattedContent, sender, true);
            
            // ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜
            if (currentChatId && allChats[currentChatId]) {
                allChats[currentChatId].messages.push({
                    content: formattedContent,
                    sender: sender,
                    timestamp: new Date()
                });
                allChats[currentChatId].messageCount = allChats[currentChatId].messages.length;
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆ
                if (sender === 'user') {
                    const userMessageCount = allChats[currentChatId].messages.filter(msg => msg.sender === 'user').length;
                    console.log('User message count:', userMessageCount, 'Current message:', content);
                    
                    if (userMessageCount === 1) {
                        // å°‘ã—é…å»¶ã•ã›ã¦ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆï¼ˆUIã®æ›´æ–°å¾Œã«å®Ÿè¡Œï¼‰
                        setTimeout(() => {
                            generateChatTitle(content);
                        }, 100);
                    }
                }
            }
        }

        // ãƒãƒ£ãƒƒãƒˆã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆ
        function generateChatTitle(firstUserMessage) {
            if (!currentChatId || !allChats[currentChatId]) {
                console.log('generateChatTitle: No current chat or chat data');
                return;
            }
            
            console.log('Generating title for message:', firstUserMessage);
            
            let title = '';
            const lowerMessage = firstUserMessage.toLowerCase();
            
            // ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦ã‚¿ã‚¤ãƒˆãƒ«ã‚’èª¿æ•´
            if (lowerMessage.includes('ã¯ã˜ã‚') || lowerMessage.includes('é–‹å§‹') || lowerMessage.includes('ãŠé¡˜ã„')) {
                title = 'ğŸ¯ è‡ªå·±ç†è§£ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹';
            } else if (lowerMessage.includes('ä¼šç¤¾') || lowerMessage.includes('ä»•äº‹') || lowerMessage.includes('è·å ´')) {
                title = 'ğŸ’¼ ä»•äº‹ãƒ»ã‚­ãƒ£ãƒªã‚¢ã«ã¤ã„ã¦';
            } else if (lowerMessage.includes('å¤¢') || lowerMessage.includes('ç›®æ¨™') || lowerMessage.includes('ã‚„ã‚ŠãŸã„')) {
                title = 'âœ¨ å¤¢ãƒ»ç›®æ¨™ã«ã¤ã„ã¦';
            } else if (lowerMessage.includes('éå»') || lowerMessage.includes('çµŒé¨“')) {
                title = 'ğŸ“š éå»ã®çµŒé¨“ã«ã¤ã„ã¦';
            } else if (lowerMessage.includes('çµ„ç¹”') || lowerMessage.includes('ãƒãƒ¼ãƒ ')) {
                title = 'ğŸ‘¥ çµ„ç¹”ãƒ»ãƒãƒ¼ãƒ ã«ã¤ã„ã¦';
            } else if (lowerMessage.includes('å¤§å­¦') || lowerMessage.includes('å­¦æ ¡') || lowerMessage.includes('éƒ¨æ´»')) {
                title = 'ğŸ“ å­¦ç”Ÿæ™‚ä»£ã«ã¤ã„ã¦';
            } else if (lowerMessage.includes('è¶£å‘³') || lowerMessage.includes('å¥½ã')) {
                title = 'ğŸ¨ è¶£å‘³ãƒ»èˆˆå‘³ã«ã¤ã„ã¦';
            } else {
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†…å®¹ã‹ã‚‰é©åˆ‡ãªé•·ã•ã§ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆ
                const cleanMessage = firstUserMessage.replace(/[ã€‚ï¼ï¼Ÿ\n]/g, '').trim();
                if (cleanMessage.length > 20) {
                    title = 'ğŸ’¬ ' + cleanMessage.substring(0, 20) + '...';
                } else if (cleanMessage.length > 0) {
                    title = 'ğŸ’¬ ' + cleanMessage;
                } else {
                    title = 'ğŸ’¬ æ–°ã—ã„ä¼šè©±';
                }
            }
            
            console.log('Generated title:', title);
            
            // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
            allChats[currentChatId].title = title;
            
            // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’æ›´æ–°
            updateChatHistory();
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            // AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨åŒæ§˜ã«å·¦å´ã«è¡¨ç¤º
            typingDiv.className = 'flex items-start space-x-3 mb-6';
            typingDiv.innerHTML = `
                <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="text-sm">ğŸ¤–</span>
                </div>
                <div class="bg-message-ai text-gray-800 rounded-2xl rounded-tl-md p-4">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // AIã®å¿œç­”ã‚’å–å¾—ï¼ˆDify APIã‚’ä½¿ç”¨ï¼‰
        async function getAIResponse(userMessage) {
            isTyping = true;
            showTypingIndicator();
            
            try {
                // Dify APIã‚’å‘¼ã³å‡ºã—
                const result = await difyAPI.sendMessage(userMessage, currentUser.id);
                
                hideTypingIndicator();
                addMessage(result.message, 'ai');
                
                // AIã®å¿œç­”ã‹ã‚‰Want toã‚’æŠ½å‡º
                const extractedWantTo = difyAPI.extractWantTo(result.message);
                if (extractedWantTo) {
                    console.log('Want to detected:', extractedWantTo);
                    
                    // UIã‚’æ›´æ–°
                    updateLatestWantTo(extractedWantTo.wantTo);
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯ã®Want toã¨ã—ã¦Airtableã«ä¿å­˜ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³é–¢ä¿‚ãªã—ï¼‰
                    await saveWantTo(extractedWantTo.wantTo, extractedWantTo.confidence);
                }
                
                isTyping = false;
            } catch (error) {
                hideTypingIndicator();
                console.error('Error getting AI response:', error);
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”
                const fallbackResponse = 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ä¸€æ™‚çš„ã«ã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                addMessage(fallbackResponse, 'ai');
                isTyping = false;
            }
        }

        // AIã®å¿œç­”ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆé–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ï¼‰
        function simulateAIResponse(userMessage) {
            isTyping = true;
            showTypingIndicator();
            
            // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã•ã‚ŒãŸå¿œç­”ï¼ˆé–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ï¼‰
            setTimeout(async () => {
                hideTypingIndicator();
                
                // ã‚µãƒ³ãƒ—ãƒ«å¿œç­”
                let response = '';
                if (userMessage.toLowerCase().includes('ã¯ã˜ã‚') || userMessage.toLowerCase().includes('ãŠé¡˜ã„')) {
                    response = `ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ãã‚Œã§ã¯ã€è‡ªå·±ç†è§£ã®æ—…ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚

ã¾ãšæœ€åˆã«ã€ã“ã‚Œã¾ã§ã®ã‚ãªãŸã®çµŒé¨“ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚

éå»ã«æ‰€å±ã—ãŸä¼šç¤¾ã‚„çµ„ç¹”ã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã€éƒ¨æ´»ãªã©ã€äººã¨ã®é–¢ã‚ã‚ŠãŒã‚ã‚‹å ´æ‰€ã‚’æ€ã„å‡ºã—ã¦ã¿ã¦ãã ã•ã„ã€‚ãã®ä¸­ã§ã€Œè‹¦ãªãåƒã‘ãŸã€ã€Œå¤¢ä¸­ã«ãªã‚ŒãŸã€ã€Œãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒé«˜ã‹ã£ãŸã€ã¨æ„Ÿã˜ãŸå ´æ‰€ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ

ã©ã®ã‚ˆã†ãªå ´æ‰€ã ã£ãŸã‹ã€2ã¤ã»ã©æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ï¼Ÿ`;
                } else {
                    response = `ãªã‚‹ã»ã©ã€${userMessage}ã«ã¤ã„ã¦ãŠèã‹ã›ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚

ã‚‚ã†å°‘ã—è©³ã—ãæ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿãã®æ™‚ã®ã‚ãªãŸã®æ°—æŒã¡ã‚„ã€ã©ã®ã‚ˆã†ãªç‚¹ãŒç‰¹ã«å°è±¡ã«æ®‹ã£ã¦ã„ã‚‹ã‹ãªã©ã€å…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚

ã‚ãªãŸã®å†…å´ã«ã‚ã‚‹æœ¬å½“ã®æ¬²æ±‚ã‚’ç†è§£ã™ã‚‹ãŸã‚ã«ã€ã‚†ã£ãã‚Šã¨ä¸€ç·’ã«æ¢ã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚`;
                }
                
                addMessage(response, 'ai');
                isTyping = false;
                
                // Want to ã®æ›´æ–°ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯æ¡ä»¶ã«å¿œã˜ã¦ï¼‰
                if (Math.random() > 0.7) {
                    const sampleWantTo = 'äººã¨ã®ã¤ãªãŒã‚Šã‚’æ·±ã‚ã‚‹ã“ã¨ã§ä¾¡å€¤ã‚’å‰µé€ ã™ã‚‹';
                    console.log('Simulated Want to detected:', sampleWantTo);
                    
                    // UIã‚’æ›´æ–°
                    updateLatestWantTo(sampleWantTo);
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯ã®Want toã¨ã—ã¦Airtableã«ä¿å­˜
                    await saveWantTo(sampleWantTo, 8);
                }
            }, 2000 + Math.random() * 2000); // 2-4ç§’ã®é…å»¶
        }

        // æœ€æ–°ã®Want toã‚’èª­ã¿è¾¼ã¿
        async function loadLatestWantTo() {
            if (!currentUser) return;
            
            try {
                const latestWantTo = await airtableAPI.getLatestWantTo(currentUser.id);
                if (latestWantTo) {
                    document.getElementById('latestWantTo').textContent = latestWantTo.fields.want_to_content;
                } else {
                    document.getElementById('latestWantTo').textContent = 'ã¾ã Want toãŒç‰¹å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
                }
            } catch (error) {
                console.error('Error loading latest Want to:', error);
                document.getElementById('latestWantTo').textContent = 'Want toã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
            }
        }

        // Want toã‚’ä¿å­˜ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯ã«1ã¤ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼‰
        async function saveWantTo(wantToContent, confidenceLevel = 5) {
            if (!currentUser) return false;
            
            try {
                console.log('Saving Want to for user:', currentUser.id, 'Content:', wantToContent);
                
                const result = await airtableAPI.saveWantTo(
                    currentUser.id,
                    wantToContent,
                    confidenceLevel
                );
                
                if (result) {
                    // UIæ›´æ–°
                    document.getElementById('latestWantTo').textContent = wantToContent;
                    console.log('Want to saved successfully:', result);
                    
                    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                    showWantToUpdateNotification(wantToContent);
                    
                    return true;
                } else {
                    console.error('Failed to save Want to');
                    return false;
                }
            } catch (error) {
                console.error('Error saving Want to:', error);
                return false;
            }
        }

        // Want toæ›´æ–°é€šçŸ¥ã‚’è¡¨ç¤º
        function showWantToUpdateNotification(wantTo) {
            // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®Want toè¡¨ç¤ºã‚’ä¸€æ™‚çš„ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            const wantToElement = document.getElementById('latestWantTo');
            const originalClass = wantToElement.className;
            
            wantToElement.className = originalClass + ' ring-2 ring-blue-500 ring-opacity-50';
            
            setTimeout(() => {
                wantToElement.className = originalClass;
            }, 2000);
        }

        // æœ€æ–°ã®Want toã‚’æ›´æ–°ï¼ˆUIã®ã¿ï¼‰
        function updateLatestWantTo(wantTo) {
            document.getElementById('latestWantTo').textContent = wantTo;
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½
        async function resetPassword(email) {
            try {
                // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
                const user = await airtableAPI.getUserByEmail(email);
                
                if (!user) {
                    throw new Error('ãã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                // ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ï¼ˆEmailJSä½¿ç”¨ï¼‰
                const templateParams = {
                    to_email: email,
                    user_id: user.fields.user_id,
                    password: user.fields.password,
                    reset_time: new Date().toLocaleString('ja-JP')
                };
                
                if (typeof emailjs !== 'undefined') {
                    await emailjs.send(
                        EMAILJS_CONFIG.serviceId,
                        EMAILJS_CONFIG.templateId,
                        templateParams
                    );
                    return true;
                } else {
                    // EmailJS ãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    console.log('EmailJS not available. Password for', user.fields.user_id, ':', user.fields.password);
                    alert(`ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆæƒ…å ±:\nãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${user.fields.user_id}\nãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ${user.fields.password}\n\nâ€» å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½ã¯è¨­å®šãŒå¿…è¦ã§ã™`);
                    return true;
                }
            } catch (error) {
                console.error('Error resetting password:', error);
                throw error;
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
        document.addEventListener('DOMContentLoaded', function() {
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById('loginModal').classList.remove('hidden');
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸæ–¹ã¯ã“ã¡ã‚‰
            document.getElementById('forgotPasswordBtn').addEventListener('click', function() {
                document.getElementById('loginFormContainer').classList.add('hidden');
                document.getElementById('resetFormContainer').classList.remove('hidden');
            });
            
            // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
            document.getElementById('backToLoginBtn').addEventListener('click', function() {
                document.getElementById('resetFormContainer').classList.add('hidden');
                document.getElementById('loginFormContainer').classList.remove('hidden');
                document.getElementById('resetEmail').value = '';
            });
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
            document.getElementById('resetForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const email = document.getElementById('resetEmail').value;
                
                if (!email) {
                    alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'é€ä¿¡ä¸­...';
                submitBtn.disabled = true;
                
                try {
                    await resetPassword(email);
                    alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
                    
                    // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
                    document.getElementById('resetFormContainer').classList.add('hidden');
                    document.getElementById('loginFormContainer').classList.remove('hidden');
                    document.getElementById('resetEmail').value = '';
                    
                } catch (error) {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
                } finally {
                    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è§£é™¤
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });
        });
    </script>
</body>
</html>